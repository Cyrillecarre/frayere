{% extends 'base.html.twig' %}

{% block title %}New PosteTwo{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('styles/poste.css') }}">
{% endblock %}

{% block javascripts %}
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var stripe = Stripe('{{ stripe_public_key }}');

            var checkoutButton = document.getElementById('checkout-button');
            var depositButton = document.getElementById('deposit-button');

            checkoutButton.addEventListener('click', function (e) {
                e.preventDefault();
                createCheckoutSession(false); // Paiement total
            });

            depositButton.addEventListener('click', function (e) {
                e.preventDefault();
                createCheckoutSession(true); // Paiement d'acompte
            });

            function createCheckoutSession(isDeposit) {
                var totalPrice = document.querySelector('input[name="totalPrice"]').value;

                fetch("{{ path('app_payment_create') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': '{{ csrf_token('payment') }}'
                    },
                    body: JSON.stringify({
                        totalPrice: totalPrice,
                        isDeposit: isDeposit
                    })
                })
                .then(response => response.json())
                .then(session => {
                    if (session.error) {
                        alert(session.error);
                    } else {
                        return stripe.redirectToCheckout({ sessionId: session.id });
                    }
                })
                .then(result => {
                    if (result && result.error) {
                        alert(result.error.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
        });
    </script>
{% endblock %}

{% block body %}
    <hr class="hr">
    <h1 class="titre">réservation Poste 2</h1>

    {% if totalPrice is not null %}
        <div class="formPrix">
            <p>Nombre de pêcheurs : {{ numFishers }}</p>
            <p>Date d'arrivée : {{ start }}h</p>
            <p>Date de départ : {{ end }}h</p>
            <p>Nombre de nuits : {{ numNights }}</p>
            <p>Pellets : {{ pellets }}</p>
            <p>Graines : {{ graines }}</p>
            <p>Montant total : {{ totalPrice }} EUR</p>
        </div>
        <form action="{{ path('app_payment_create') }}" method="POST" class="formPrixButton">
            <input type="hidden" name="totalPrice" value="{{ totalPrice }}">
            <div>
                <button type="submit" id="checkout-button" class="btnAction">Régler la totalité</button>
            </div>
            <div>
                <button type="submit" id="deposit-button" class="btnAction" data-is-deposit="true">Régler un acompte</button>
            </div>
            <p class="textPrix">Vous allez être redirigé vers la page de paiement sécurisé</p>
        </form>
    {% endif %}

    <hr class="hr">
    <a href="{{ path('app_poste_two_new') }}" class="btnAction">Retour</a>
{% endblock %}
{% extends 'base.html.twig' %}

{% block title %}New PosteFour{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('styles/poste.css') }}">
{% endblock %}

{% block javascripts %}
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var stripe = Stripe('{{ stripe_public_key }}');
            var checkoutButton = document.getElementById('checkout-button');

            checkoutButton.addEventListener('click', function (e) {
                e.preventDefault();

                var totalPrice = document.querySelector('input[name="totalPrice"]').value;

                fetch("{{ path('app_payment_create') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': '{{ csrf_token('payment') }}'
                    },
                    body: JSON.stringify({
                        totalPrice: totalPrice
                    })
                })
                .then(response => response.json())
                .then(session => {
                    return stripe.redirectToCheckout({ sessionId: session.id });
                })
                .then(result => {
                    if (result.error) {
                        alert(result.error.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });
    </script>
{% endblock %}

{% block body %}
    <hr class="hr">
    <h1 class="titre">réservation Poste 4</h1>

    {% if totalPrice is not null %}
        <div class="formPrix">
            <p>Nombre de pêcheurs : {{ numFishers }}</p>
            <p>Date d'arrivée : {{ start }}h</p>
            <p>Date de départ : {{ end }}h</p>
            <p>Nombre de nuits : {{ numNights }}</p>
            <p>Pellets : {{ pellets }}</p>
            <p>Graines : {{ graines }}</p>
            <p>Montant total : {{ totalPrice }} EUR</p>
        </div>
        <form action="{{ path('app_payment_create') }}" method="POST">
            <input type="hidden" name="totalPrice" value="{{ totalPrice }}">
            <button type="submit" id="checkout-button" class="btnAction">Payer</button>
            <p class="textPrix">Vous allez être redirigé vers la page de paiement sécurisé</p>
        </form>
    {% endif %}

    <hr class="hr">
    <a href="{{ path('app_poste_four_new') }}" class="btnAction">Retour</a>
{% endblock %}